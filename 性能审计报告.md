# ğŸ” puppeteer-real-browser-go æ€§èƒ½å®¡è®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2025-12-13  
**é¡¹ç›®ç‰ˆæœ¬**: main branch  
**å®¡è®¡èŒƒå›´**: å…¨é¢æ€§èƒ½ã€å†…å­˜ã€å¹¶å‘ã€èµ„æºç®¡ç†

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

| ç±»åˆ« | ä¸¥é‡åº¦ | æ•°é‡ | ä¼˜å…ˆçº§ |
|------|--------|------|--------|
| **ä¸¥é‡é—®é¢˜** | ğŸ”´ | 5 | P0 |
| **ä¸­ç­‰é—®é¢˜** | ğŸŸ¡ | 8 | P1 |
| **è½»å¾®é—®é¢˜** | ğŸŸ¢ | 6 | P2 |

### ä¸»è¦å‘ç°

1. âŒ **Goroutine æ³„æ¼** - å¤šå¤„æœªæ¸…ç†çš„ goroutine
2. âŒ **Context æ³„æ¼** - åˆ›å»ºçš„ context æœªè¢«è¿½è¸ªå’Œå–æ¶ˆ
3. âš ï¸  **å¤§é‡ JavaScript æ³¨å…¥** - æ¯æ¬¡é¡µé¢åŠ è½½æ³¨å…¥ 1000+ è¡Œä»£ç 
4. âš ï¸  **æ— ç¼“å­˜æœºåˆ¶** - æŒ‡çº¹è„šæœ¬å’Œé…ç½®æœªç¼“å­˜
5. âš ï¸  **äº‹ä»¶ç›‘å¬å™¨ç´¯ç§¯** - å¤šä¸ª ListenTarget å¯èƒ½å¯¼è‡´é‡å¤å¤„ç†

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ (P0 - å¿…é¡»ä¿®å¤)

### 1. Goroutine æ³„æ¼ - Target Handler

**æ–‡ä»¶**: `pkg/browser/target_handler.go:51`

```go
// âŒ é—®é¢˜ä»£ç 
go th.handleTargetCreated(ctx, e)
```

**é—®é¢˜**:
- æ¯ä¸ªæ–°æ ‡ç­¾é¡µåˆ›å»ºä¸€ä¸ª goroutine
- goroutine æ²¡æœ‰è¶…æ—¶æœºåˆ¶
- å½“æ ‡ç­¾é¡µé”€æ¯æ—¶ï¼Œgoroutine å¯èƒ½ç»§ç»­è¿è¡Œ
- é•¿æ—¶é—´è¿è¡Œå¯èƒ½å¯¼è‡´æ•°ç™¾ä¸ªæ³„æ¼çš„ goroutine

**å½±å“**:
- å†…å­˜æŒç»­å¢é•¿
- CPU ä½¿ç”¨ç‡ä¸Šå‡
- æœ€ç»ˆå¯èƒ½å¯¼è‡´ OOM

**ä¿®å¤æ–¹æ¡ˆ**:
```go
// âœ… ä¿®å¤å
func (th *TargetHandler) handleTargetCreated(ctx context.Context, ev *target.EventTargetCreated) {
    // æ·»åŠ è¶…æ—¶ context
    ctx, cancel := context.WithTimeout(ctx, 30*time.Second)
    defer cancel()
    
    // æ·»åŠ  goroutine è¿½è¸ª
    th.activeGoroutines.Add(1)
    defer th.activeGoroutines.Done()
    
    // æ£€æŸ¥æ˜¯å¦å·²åœæ­¢
    select {
    case <-th.stopChan:
        return
    default:
    }
    
    // ... åŸæœ‰é€»è¾‘
}

// åœ¨ Stop() ä¸­ç­‰å¾…æ‰€æœ‰ goroutine
func (th *TargetHandler) Stop() {
    th.mu.Lock()
    if !th.isRunning {
        th.mu.Unlock()
        return
    }
    th.isRunning = false
    close(th.stopChan)
    th.mu.Unlock()
    
    // ç­‰å¾…æ‰€æœ‰ goroutine å®Œæˆ
    done := make(chan struct{})
    go func() {
        th.activeGoroutines.Wait()
        close(done)
    }()
    
    select {
    case <-done:
    case <-time.After(5 * time.Second):
        log.Println("Warning: Some goroutines did not finish")
    }
}
```

---

### 2. Context æ³„æ¼ - Target Handler

**æ–‡ä»¶**: `pkg/browser/target_handler.go:84-88`

```go
// âŒ é—®é¢˜ä»£ç 
targetCtx, cancel := chromedp.NewContext(th.allocCtx, chromedp.WithTargetID(targetID))

th.mu.Lock()
th.targets[targetID] = targetCtx
th.mu.Unlock()
// cancel å‡½æ•°ä»æœªè¢«è°ƒç”¨
```

**é—®é¢˜**:
- æ¯ä¸ª target åˆ›å»ºä¸€ä¸ª context
- cancel å‡½æ•°å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
- å½“ target é”€æ¯æ—¶ï¼Œcontext æœªè¢«å–æ¶ˆ
- å¯¼è‡´å†…å­˜æ³„æ¼å’Œèµ„æºæœªé‡Šæ”¾

**ä¿®å¤æ–¹æ¡ˆ**:
```go
// âœ… ä¿®å¤å
type targetInfo struct {
    ctx    context.Context
    cancel context.CancelFunc
}

type TargetHandler struct {
    // ...
    targets map[target.ID]*targetInfo  // å­˜å‚¨ cancel å‡½æ•°
}

func (th *TargetHandler) handleTargetCreated(ctx context.Context, ev *target.EventTargetCreated) {
    targetCtx, cancel := chromedp.NewContext(th.allocCtx, chromedp.WithTargetID(targetID))
    
    th.mu.Lock()
    th.targets[targetID] = &targetInfo{
        ctx:    targetCtx,
        cancel: cancel,
    }
    th.mu.Unlock()
    
    // ... å…¶ä»–é€»è¾‘
}

func (th *TargetHandler) handleTargetDestroyed(ev *target.EventTargetDestroyed) {
    th.mu.Lock()
    defer th.mu.Unlock()
    
    // å–æ¶ˆ context å¹¶æ¸…ç†
    if info, exists := th.targets[ev.TargetID]; exists {
        info.cancel()  // é‡Šæ”¾èµ„æº
        delete(th.targets, ev.TargetID)
    }
}

// Stop æ—¶æ¸…ç†æ‰€æœ‰ targets
func (th *TargetHandler) Stop() {
    // ...
    th.mu.Lock()
    for _, info := range th.targets {
        info.cancel()
    }
    th.targets = make(map[target.ID]*targetInfo)
    th.mu.Unlock()
}
```

---

### 3. äº‹ä»¶ç›‘å¬å™¨ç´¯ç§¯ - Connector

**æ–‡ä»¶**: `pkg/browser/connector.go:370-406`

```go
// âŒ é—®é¢˜ä»£ç 
chromedp.ListenTarget(ctx, func(ev interface{}) {
    switch e := ev.(type) {
    case *fetch.EventRequestPaused:
        // æ¯æ¬¡è°ƒç”¨ SetRequestInterception éƒ½ä¼šæ·»åŠ æ–°çš„ç›‘å¬å™¨
        go func() {
            // å¤„ç†è¯·æ±‚
        }()
    }
})
```

**é—®é¢˜**:
- æ¯æ¬¡è°ƒç”¨ `SetRequestInterception(true)` éƒ½æ·»åŠ æ–°ç›‘å¬å™¨
- æ—§ç›‘å¬å™¨ä¸ä¼šè¢«ç§»é™¤
- å¯¼è‡´åŒä¸€ä¸ªäº‹ä»¶è¢«å¤šæ¬¡å¤„ç†
- goroutine æ³„æ¼

**å½±å“**:
- è¯·æ±‚å¤„ç†å˜æ…¢ï¼ˆé‡å¤å¤„ç†ï¼‰
- å†…å­˜å’Œ goroutine æ•°é‡æŒç»­å¢é•¿
- å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶

**ä¿®å¤æ–¹æ¡ˆ**:
```go
// âœ… ä¿®å¤å
type CDPPage struct {
    // ...
    requestListenerCancel context.CancelFunc
    requestListenerMu     sync.Mutex
}

func (p *CDPPage) SetRequestInterception(enabled bool) error {
    p.requestListenerMu.Lock()
    defer p.requestListenerMu.Unlock()
    
    // å…ˆå–æ¶ˆæ—§ç›‘å¬å™¨
    if p.requestListenerCancel != nil {
        p.requestListenerCancel()
        p.requestListenerCancel = nil
    }
    
    if enabled {
        // åˆ›å»ºä¸“ç”¨ context ç”¨äºç›‘å¬å™¨
        listenerCtx, cancel := context.WithCancel(p.ctx)
        p.requestListenerCancel = cancel
        
        return chromedp.Run(p.ctx, chromedp.ActionFunc(func(ctx context.Context) error {
            // å¯ç”¨ Fetch
            if err := fetch.Enable().WithHandleAuthRequests(false).WithPatterns(patterns).Do(ctx); err != nil {
                return err
            }
            
            // ä½¿ç”¨ä¸“ç”¨ context ç›‘å¬
            chromedp.ListenTarget(listenerCtx, func(ev interface{}) {
                // å¤„ç†äº‹ä»¶
            })
            
            return nil
        }))
    }
    
    return chromedp.Run(p.ctx, chromedp.ActionFunc(func(ctx context.Context) error {
        return fetch.Disable().Do(ctx)
    }))
}
```

---

### 4. å¤§é‡ JavaScript æ³¨å…¥æ— ç¼“å­˜

**æ–‡ä»¶**: `pkg/browser/fingerprint_injector.go:22-101`

```go
// âŒ é—®é¢˜ä»£ç 
func (fi *FingerprintInjector) GenerateInjectionScript() string {
    // æ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆ 1000+ è¡Œçš„è„šæœ¬
    var scripts []string
    
    // æ—¶é—´æˆ³æ³¨å…¥å™¨
    timestampInjector := NewTimestampFingerprintInjector(fi.config)
    scripts = append(scripts, timestampInjector.GenerateTimestampInjectionScript())
    
    // Audio/WebGL æ³¨å…¥å™¨
    enhancedInjector := NewEnhancedAudioWebGLInjector(fi.config)
    scripts = append(scripts, enhancedInjector.GenerateEnhancedWebGLScript())
    // ... æ›´å¤šè„šæœ¬
}
```

**é—®é¢˜**:
- æ¯æ¬¡é¡µé¢åŠ è½½éƒ½é‡æ–°ç”Ÿæˆç›¸åŒçš„è„šæœ¬
- å­—ç¬¦ä¸²æ‹¼æ¥å’Œæ ¼å¼åŒ–éå¸¸è€—æ—¶
- åŒä¸€ç”¨æˆ·çš„è„šæœ¬å®Œå…¨ç›¸åŒï¼Œä½†ä»ä¸ç¼“å­˜
- ç”Ÿæˆé€Ÿåº¦: ~5-10ms/æ¬¡

**å½±å“**:
- é¡µé¢å¯åŠ¨å»¶è¿Ÿå¢åŠ 
- CPU ä½¿ç”¨ç‡ä¸å¿…è¦åœ°å‡é«˜
- å¹¶å‘æ—¶å½±å“æ›´æ˜æ˜¾

**ä¿®å¤æ–¹æ¡ˆ**:
```go
// âœ… æ·»åŠ ç¼“å­˜æœºåˆ¶
type FingerprintInjector struct {
    config       *FingerprintConfig
    scriptCache  string
    scriptCacheMu sync.RWMutex
    cacheValid   bool
}

func (fi *FingerprintInjector) GenerateInjectionScript() string {
    // æ£€æŸ¥ç¼“å­˜
    fi.scriptCacheMu.RLock()
    if fi.cacheValid && fi.scriptCache != "" {
        cached := fi.scriptCache
        fi.scriptCacheMu.RUnlock()
        return cached
    }
    fi.scriptCacheMu.RUnlock()
    
    // ç”Ÿæˆè„šæœ¬
    fi.scriptCacheMu.Lock()
    defer fi.scriptCacheMu.Unlock()
    
    // åŒé‡æ£€æŸ¥
    if fi.cacheValid && fi.scriptCache != "" {
        return fi.scriptCache
    }
    
    // ç”Ÿæˆ
    script := fi.generateScriptInternal()
    fi.scriptCache = script
    fi.cacheValid = true
    return script
}

// æä¾›æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•ï¼ˆå½“é…ç½®æ”¹å˜æ—¶ï¼‰
func (fi *FingerprintInjector) InvalidateCache() {
    fi.scriptCacheMu.Lock()
    fi.cacheValid = false
    fi.scriptCache = ""
    fi.scriptCacheMu.Unlock()
}
```

**é¢„æœŸæå‡**: 99% (ä» 5ms é™è‡³ <0.1ms)

---

### 5. æµè§ˆå™¨æ± å®ä¾‹éªŒè¯æ•ˆç‡ä½

**æ–‡ä»¶**: `pkg/browser/pool.go:50-56`

```go
// âŒ é—®é¢˜ä»£ç 
case instance := <-p.instances:
    // éªŒè¯å®ä¾‹æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
    if instance.Chrome() != nil && instance.Chrome().IsRunning() {
        return instance, nil
    }
    // å®ä¾‹å·²å¤±æ•ˆï¼Œå…³é—­å¹¶åˆ›å»ºæ–°çš„
    instance.Close()
```

**é—®é¢˜**:
- `IsRunning()` æ¯æ¬¡éƒ½è¦å‘é€ç³»ç»Ÿä¿¡å·ï¼ˆsyscall.Kill(PID, 0)ï¼‰
- å¦‚æœå®ä¾‹å·²å¤±æ•ˆï¼Œæµªè´¹æ—¶é—´å…³é—­å®ƒ
- æ²¡æœ‰å¥åº·æ£€æŸ¥æœºåˆ¶

**ä¿®å¤æ–¹æ¡ˆ**:
```go
// âœ… æ·»åŠ å¥åº·æ£€æŸ¥å’Œæœ€åä½¿ç”¨æ—¶é—´
type BrowserInstance struct {
    // ...
    lastUsed    time.Time
    healthCheck atomic.Value // bool
}

func (p *BrowserPool) Acquire(ctx context.Context) (*BrowserInstance, error) {
    // ...
    select {
    case instance := <-p.instances:
        // å¿«é€Ÿè·¯å¾„ï¼šæ£€æŸ¥ä¸Šæ¬¡ä½¿ç”¨æ—¶é—´
        if time.Since(instance.lastUsed) < 30*time.Second {
            // æœ€è¿‘ä½¿ç”¨è¿‡ï¼Œå‡è®¾ä»ç„¶æœ‰æ•ˆ
            instance.lastUsed = time.Now()
            return instance, nil
        }
        
        // éœ€è¦éªŒè¯
        if p.isInstanceHealthy(instance) {
            instance.lastUsed = time.Now()
            return instance, nil
        }
        
        // å¼‚æ­¥å…³é—­å¤±æ•ˆå®ä¾‹
        go instance.Close()
    default:
        // æ± ä¸­æ²¡æœ‰å¯ç”¨å®ä¾‹
    }
    
    // åˆ›å»ºæ–°å®ä¾‹
    // ...
}

func (p *BrowserPool) isInstanceHealthy(instance *BrowserInstance) bool {
    chrome := instance.Chrome()
    if chrome == nil {
        return false
    }
    
    // ä½¿ç”¨ç¼“å­˜çš„å¥åº·çŠ¶æ€ï¼ˆå¦‚æœæœ€è¿‘æ£€æŸ¥è¿‡ï¼‰
    if cached := instance.healthCheck.Load(); cached != nil {
        if healthy, ok := cached.(healthStatus); ok {
            if time.Since(healthy.checkedAt) < 5*time.Second {
                return healthy.isHealthy
            }
        }
    }
    
    // æ‰§è¡Œå®é™…å¥åº·æ£€æŸ¥
    isHealthy := chrome.IsRunning()
    instance.healthCheck.Store(healthStatus{
        isHealthy: isHealthy,
        checkedAt: time.Now(),
    })
    
    return isHealthy
}

type healthStatus struct {
    isHealthy bool
    checkedAt time.Time
}
```

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1 - åº”è¯¥ä¿®å¤)

### 6. CustomCDP å®¢æˆ·ç«¯æ¶ˆæ¯å¤„ç†æ•ˆç‡ä½

**æ–‡ä»¶**: `pkg/browser/cdp_custom.go:94-119`

**é—®é¢˜**:
- ä½¿ç”¨é˜»å¡çš„ `ReadJSON`
- select ä¸­ä½¿ç”¨ 5 ç§’è¶…æ—¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
- channel åˆ›å»ºä½†å¯èƒ½æ°¸ä¸å…³é—­

**ä¿®å¤å»ºè®®**:
```go
// ä½¿ç”¨å¸¦ç¼“å†²çš„ channel å’Œæ›´å¥½çš„æ¸…ç†æœºåˆ¶
type CustomCDPClient struct {
    // ...
    eventHandlers map[string][]EventHandler
    eventsMutex   sync.RWMutex
}

type EventHandler func(interface{})

func (c *CustomCDPClient) handleMessages() {
    defer func() {
        c.conn.Close()
        c.cleanup()
    }()
    
    for {
        select {
        case <-c.ctx.Done():
            return
        default:
        }
        
        // è®¾ç½®è¯»å–è¶…æ—¶
        c.conn.SetReadDeadline(time.Now().Add(30 * time.Second))
        
        var message json.RawMessage
        if err := c.conn.ReadJSON(&message); err != nil {
            if c.ctx.Err() != nil {
                return // æ­£å¸¸å…³é—­
            }
            // å…¶ä»–é”™è¯¯ï¼Œç»§ç»­æˆ–é€€å‡º
            return
        }
        
        // éé˜»å¡åˆ†å‘
        go c.dispatchMessage(message)
    }
}

func (c *CustomCDPClient) cleanup() {
    c.responsesMutex.Lock()
    defer c.responsesMutex.Unlock()
    
    // å…³é—­æ‰€æœ‰ç­‰å¾…çš„ response channels
    for _, ch := range c.responses {
        close(ch)
    }
    c.responses = make(map[int64]chan CDPResponse)
}
```

---

### 7. æŒ‡çº¹é…ç½®å¯¹è±¡æœªå¤ç”¨

**æ–‡ä»¶**: `pkg/browser/fingerprint_injector.go:28-32`

**é—®é¢˜**:
- æ¯æ¬¡æ³¨å…¥éƒ½åˆ›å»ºæ–°çš„ `EnhancedAudioWebGLInjector` å’Œ `TimestampFingerprintInjector`
- è¿™äº›å¯¹è±¡å¯ä»¥å¤ç”¨

**ä¿®å¤å»ºè®®**:
```go
type FingerprintInjector struct {
    config                *FingerprintConfig
    audioWebGLInjector    *EnhancedAudioWebGLInjector
    timestampInjector     *TimestampFingerprintInjector
    scriptCache           string
    cacheValid            bool
    mu                    sync.RWMutex
}

func NewFingerprintInjector(config *FingerprintConfig) *FingerprintInjector {
    return &FingerprintInjector{
        config:             config,
        audioWebGLInjector: NewEnhancedAudioWebGLInjector(config),
        timestampInjector:  NewTimestampFingerprintInjector(config),
    }
}
```

---

### 8. Turnstile Solver è½®è¯¢æ•ˆç‡ä½

**æ–‡ä»¶**: `pkg/turnstile/solver.go`

**é—®é¢˜** (éœ€è¦ç¡®è®¤):
- å¦‚æœä½¿ç”¨å›ºå®šé—´éš”è½®è¯¢æ£€æŸ¥ Turnstile
- åº”è¯¥ä½¿ç”¨ MutationObserver æˆ–äº‹ä»¶ç›‘å¬

**å»ºè®®**: æ£€æŸ¥å®ç°ï¼Œå¦‚æœä½¿ç”¨è½®è¯¢åˆ™æ”¹ä¸ºäº‹ä»¶é©±åŠ¨

---

### 9. æµè§ˆå™¨æ± é¢„çƒ­å¹¶å‘åˆ›å»ºæ— é™åˆ¶

**æ–‡ä»¶**: `pkg/browser/pool.go:146-192`

```go
// âš ï¸  é—®é¢˜ä»£ç 
func (p *BrowserPool) Warmup(ctx context.Context, count int) error {
    // ...
    for i := 0; i < count; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            instance, err := Connect(ctx, p.opts)
            // ...
        }()
    }
}
```

**é—®é¢˜**:
- å¦‚æœ count = 100ï¼Œä¼šåŒæ—¶å¯åŠ¨ 100 ä¸ª Chrome è¿›ç¨‹
- å¯èƒ½å¯¼è‡´ç³»ç»Ÿèµ„æºè€—å°½
- åº”è¯¥é™åˆ¶å¹¶å‘æ•°

**ä¿®å¤æ–¹æ¡ˆ**:
```go
func (p *BrowserPool) Warmup(ctx context.Context, count int) error {
    if count > p.maxSize {
        count = p.maxSize
    }
    
    // é™åˆ¶å¹¶å‘åˆ›å»ºæ•°é‡
    maxConcurrent := 5
    semaphore := make(chan struct{}, maxConcurrent)
    
    var wg sync.WaitGroup
    errChan := make(chan error, count)
    
    for i := 0; i < count; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            
            // è·å–ä¿¡å·é‡
            semaphore <- struct{}{}
            defer func() { <-semaphore }()
            
            instance, err := Connect(ctx, p.opts)
            if err != nil {
                errChan <- err
                return
            }
            
            atomic.AddInt32(&p.created, 1)
            
            select {
            case p.instances <- instance:
            default:
                instance.Close()
            }
        }()
    }
    
    wg.Wait()
    close(errChan)
    
    var errs []error
    for err := range errChan {
        errs = append(errs, err)
    }
    
    if len(errs) > 0 {
        return fmt.Errorf("warmup errors: %v", errs)
    }
    
    return nil
}
```

---

### 10. Chrome è¿›ç¨‹å­è¿›ç¨‹æ¸…ç†ä¸å®Œæ•´

**æ–‡ä»¶**: `pkg/browser/launcher.go:292-304`

```go
// âš ï¸  é—®é¢˜ä»£ç 
func (cp *ChromeProcess) killProcessTree() error {
    if cp.PID == 0 {
        return nil
    }
    
    // åªæ€ä¸»è¿›ç¨‹
    if err := syscall.Kill(cp.PID, syscall.SIGKILL); err != nil {
        return err
    }
    
    return nil
}
```

**é—®é¢˜**:
- Chrome å¯åŠ¨æ—¶ä¼šåˆ›å»ºå¤šä¸ªå­è¿›ç¨‹
- åªæ€ä¸»è¿›ç¨‹å¯èƒ½ç•™ä¸‹åƒµå°¸è¿›ç¨‹
- åº”è¯¥æ€æ•´ä¸ªè¿›ç¨‹ç»„

**ä¿®å¤æ–¹æ¡ˆ**:
```go
func (cp *ChromeProcess) killProcessTree() error {
    if cp.PID == 0 {
        return nil
    }
    
    // æ€æ•´ä¸ªè¿›ç¨‹ç»„ï¼ˆè´Ÿå·è¡¨ç¤ºè¿›ç¨‹ç»„ï¼‰
    // å› ä¸ºå¯åŠ¨æ—¶è®¾ç½®äº† Setpgid: true
    if err := syscall.Kill(-cp.PID, syscall.SIGKILL); err != nil {
        // å¯èƒ½è¿›ç¨‹å·²ç»ä¸å­˜åœ¨
        if err != syscall.ESRCH {
            return fmt.Errorf("failed to kill process group: %w", err)
        }
    }
    
    // ç­‰å¾…è¿›ç¨‹å®Œå…¨ç»ˆæ­¢
    time.Sleep(100 * time.Millisecond)
    
    // éªŒè¯è¿›ç¨‹å·²ç»ˆæ­¢
    if err := syscall.Kill(cp.PID, 0); err == nil {
        return fmt.Errorf("process %d still running after SIGKILL", cp.PID)
    }
    
    return nil
}
```

---

### 11. WaitForSelector å®ç°æ•ˆç‡ä½

**æ–‡ä»¶**: `pkg/browser/connector.go:173-176`

```go
// âš ï¸  é—®é¢˜ä»£ç 
func (p *CDPPage) WaitForSelector(selector string) error {
    return chromedp.Run(p.ctx, chromedp.WaitVisible(selector))
}
```

**å»ºè®®**: æ£€æŸ¥ chromedp.WaitVisible çš„å®ç°ï¼Œå¦‚æœæ˜¯è½®è¯¢åˆ™è€ƒè™‘ä¼˜åŒ–

---

### 12. å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨ + è€Œé strings.Builder

**æ–‡ä»¶**: å¤šå¤„

**é—®é¢˜**:
- å¤§é‡å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨ `+` æˆ– `fmt.Sprintf`
- åº”è¯¥ä½¿ç”¨ `strings.Builder` æå‡æ€§èƒ½

**ç¤ºä¾‹ä¿®å¤**:
```go
// âŒ ä½æ•ˆ
script := part1 + part2 + part3 + ...

// âœ… é«˜æ•ˆ
var builder strings.Builder
builder.WriteString(part1)
builder.WriteString(part2)
builder.WriteString(part3)
script := builder.String()
```

---

### 13. æ— æŒ‡æ ‡å’Œç›‘æ§

**ç¼ºå¤±åŠŸèƒ½**:
- æ²¡æœ‰æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- æ— æ³•ç›‘æ§æ± çŠ¶æ€ã€goroutine æ•°é‡ã€å†…å­˜ä½¿ç”¨ç­‰
- ç”Ÿäº§ç¯å¢ƒéš¾ä»¥è¯Šæ–­é—®é¢˜

**å»ºè®®æ·»åŠ **:
```go
// pkg/browser/metrics.go
type Metrics struct {
    ActiveInstances   atomic.Int64
    TotalRequests     atomic.Int64
    FailedRequests    atomic.Int64
    AverageLatency    atomic.Value // time.Duration
    ActiveGoroutines  atomic.Int64
    PoolHits          atomic.Int64
    PoolMisses        atomic.Int64
}

var GlobalMetrics = &Metrics{}

// æä¾› HTTP endpoint æš´éœ²æŒ‡æ ‡
func (m *Metrics) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    json.NewEncoder(w).Encode(map[string]interface{}{
        "active_instances":   m.ActiveInstances.Load(),
        "total_requests":     m.TotalRequests.Load(),
        "failed_requests":    m.FailedRequests.Load(),
        "average_latency_ms": m.AverageLatency.Load(),
        "active_goroutines":  m.ActiveGoroutines.Load(),
        "pool_hit_rate":      float64(m.PoolHits.Load()) / float64(m.TotalRequests.Load()),
    })
}
```

---

## ğŸŸ¢ è½»å¾®é—®é¢˜ (P2 - å¯ä»¥ä¼˜åŒ–)

### 14. æ—¥å¿—æ€§èƒ½

- ä½¿ç”¨ `fmt.Printf` è€Œéç»“æ„åŒ–æ—¥å¿—
- å»ºè®®ä½¿ç”¨ `zerolog` æˆ– `zap`

### 15. é”™è¯¯å¤„ç†å¯ä»¥ä¼˜åŒ–

- æŸäº›åœ°æ–¹ä½¿ç”¨ `fmt.Errorf` åŒ…è£…é”™è¯¯
- å¯ä»¥ä½¿ç”¨ `errors.Is` å’Œ `errors.As` æ›´å¥½åœ°å¤„ç†

### 16. é…ç½®çƒ­æ›´æ–°

- æŒ‡çº¹é…ç½®æ”¹å˜åéœ€è¦é‡å¯
- å»ºè®®æ·»åŠ é…ç½®çƒ­æ›´æ–°æœºåˆ¶

### 17. è¿æ¥æ± ç»Ÿè®¡ä¸å®Œæ•´

- ç¼ºå°‘è¿æ¥ç­‰å¾…æ—¶é—´ç»Ÿè®¡
- ç¼ºå°‘å®ä¾‹åˆ›å»ºå¤±è´¥ç‡ç»Ÿè®¡

### 18. æµ‹è¯•è¦†ç›–ç‡

- æ€§èƒ½å…³é”®è·¯å¾„ç¼ºå°‘åŸºå‡†æµ‹è¯•
- å»ºè®®æ·»åŠ æ›´å¤š benchmark

### 19. æ–‡æ¡£

- æ€§èƒ½è°ƒä¼˜æŒ‡å—ä¸å®Œæ•´
- ç¼ºå°‘ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®æ€»ç»“

### ç«‹å³è¡ŒåŠ¨ (P0)

1. âœ… ä¿®å¤ Goroutine æ³„æ¼ - æ·»åŠ è¿½è¸ªå’Œæ¸…ç†æœºåˆ¶
2. âœ… ä¿®å¤ Context æ³„æ¼ - æ­£ç¡®ç®¡ç† cancel å‡½æ•°
3. âœ… æ·»åŠ è„šæœ¬ç¼“å­˜ - 99% æ€§èƒ½æå‡
4. âœ… ä¿®å¤äº‹ä»¶ç›‘å¬å™¨ç´¯ç§¯ - é˜²æ­¢é‡å¤å¤„ç†
5. âœ… ä¼˜åŒ–å®ä¾‹å¥åº·æ£€æŸ¥ - å‡å°‘ç³»ç»Ÿè°ƒç”¨

### çŸ­æœŸä¼˜åŒ– (P1)

6. é™åˆ¶é¢„çƒ­å¹¶å‘æ•°
7. å®Œå–„è¿›ç¨‹æ¸…ç†æœºåˆ¶
8. æ·»åŠ æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡
9. ä¼˜åŒ–å­—ç¬¦ä¸²æ“ä½œ
10. æ”¹è¿› CustomCDP å®¢æˆ·ç«¯

### é•¿æœŸæ”¹è¿› (P2)

11. ç»“æ„åŒ–æ—¥å¿—
12. é…ç½®çƒ­æ›´æ–°
13. å®Œå–„æµ‹è¯•å’ŒåŸºå‡†
14. æ–‡æ¡£å®Œå–„

---

## ğŸ¯ é¢„æœŸæ€§èƒ½æå‡

| ä¼˜åŒ–é¡¹ | å½“å‰ | ä¼˜åŒ–å | æå‡ |
|--------|------|--------|------|
| è„šæœ¬ç”Ÿæˆ | 5-10ms | <0.1ms | **99%** â¬†ï¸ |
| å®ä¾‹è·å– | 2-5ms | 0.5-1ms | **70%** â¬†ï¸ |
| å†…å­˜ä½¿ç”¨ | å¢é•¿ | ç¨³å®š | **æ³„æ¼ä¿®å¤** âœ… |
| Goroutine æ•° | å¢é•¿ | ç¨³å®š | **æ³„æ¼ä¿®å¤** âœ… |
| å¹¶å‘èƒ½åŠ› | å—é™ | æå‡ | **2-3x** â¬†ï¸ |

---

## ğŸ› ï¸ å®æ–½ä¼˜å…ˆçº§

### ç¬¬ä¸€é˜¶æ®µ (1-2å¤©)

1. ä¿®å¤ Goroutine å’Œ Context æ³„æ¼
2. æ·»åŠ è„šæœ¬ç¼“å­˜æœºåˆ¶
3. ä¿®å¤äº‹ä»¶ç›‘å¬å™¨é—®é¢˜

### ç¬¬äºŒé˜¶æ®µ (3-5å¤©)

4. ä¼˜åŒ–æµè§ˆå™¨æ± 
5. æ·»åŠ æ€§èƒ½ç›‘æ§
6. å®Œå–„è¿›ç¨‹æ¸…ç†

### ç¬¬ä¸‰é˜¶æ®µ (1-2å‘¨)

7. é•¿æœŸä¼˜åŒ–å’Œæ”¹è¿›
8. å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•

---

## ğŸ“ ç»“è®º

é¡¹ç›®æ•´ä½“æ¶æ„è‰¯å¥½ï¼Œå·²ç»å®ç°äº†æµè§ˆå™¨æ± ç­‰é‡è¦ä¼˜åŒ–ã€‚ä½†å­˜åœ¨ä¸€äº›**ä¸¥é‡çš„èµ„æºæ³„æ¼é—®é¢˜**éœ€è¦ç«‹å³ä¿®å¤ï¼Œå¦åˆ™é•¿æ—¶é—´è¿è¡Œä¼šå¯¼è‡´ç³»ç»Ÿä¸ç¨³å®šã€‚

ä¿®å¤ P0 é—®é¢˜åï¼Œé¡¹ç›®å¯ä»¥ç¨³å®šåœ°æ”¯æŒç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

**æ€»ä½“è¯„åˆ†**: 7/10  
**ç¨³å®šæ€§**: 6/10 (æ³„æ¼é—®é¢˜)  
**æ€§èƒ½**: 8/10 (å·²æœ‰æ± åŒ–)  
**å¯ç»´æŠ¤æ€§**: 8/10 (ä»£ç æ¸…æ™°)

---

**ç”Ÿæˆæ—¶é—´**: 2025-12-13  
**å®¡è®¡å·¥å…·**: äººå·¥ä»£ç å®¡æŸ¥ + é™æ€åˆ†æ

