# 📊 资源监控使用指南

两个强大的工具帮助你监控和测试浏览器池的资源使用和稳定性。

---

## 🔍 工具 1: 实时资源监控

**位置**: `cmd/monitor/main.go`

### 功能特点

- ✅ **实时监控**: 每 2 秒刷新一次
- ✅ **全面指标**: 内存、CPU、Goroutine、池状态、请求统计
- ✅ **彩色输出**: 根据状态显示不同颜色（绿/黄/红）
- ✅ **自动导出**: 测试结束后导出 JSON 报告

### 快速开始

```bash
# 运行监控（会自动模拟请求）
go run cmd/monitor/main.go
```

### 监控面板示例

```
╔════════════════════════════════════════════════════════════════╗
║          🔍 Puppeteer Real Browser - 资源监控面板              ║
╚════════════════════════════════════════════════════════════════╝

⏰ 时间: 2025-12-13 14:30:45
⏱️  运行时长: 2m 30s

─── Go 运行时 ─────────────────────────────────────────────────
🔢 Goroutine 数量: 45
💾 内存分配: 285.50 MB / 512.00 MB (55.8%)
🗑️  GC 次数: 12

─── 浏览器池 ─────────────────────────────────────────────────
📦 池容量: 10 (最大: 10)
✅ 可用实例: 7
📊 使用率: 30.0%
🌐 Chrome 进程: 10

─── 请求统计 ─────────────────────────────────────────────────
📨 总请求: 156
✅ 成功: 152
❌ 失败: 4
📈 成功率: 97.44%

───────────────────────────────────────────────────────────────

💡 提示: 按 Ctrl+C 停止监控
```

### 颜色含义

| 指标 | 🟢 绿色 | 🟡 黄色 | 🔴 红色 |
|------|---------|---------|---------|
| **Goroutine** | < 100 | 100-500 | > 500 |
| **内存使用** | < 70% | 70-85% | > 85% |
| **池可用性** | > 50% | 1-50% | 0 |
| **成功率** | ≥ 95% | 80-95% | < 80% |

### 自定义监控

如果你想监控自己的代码：

```go
package main

import (
    "context"
    "time"
    "github.com/r0vx/puppeteer-real-browser-go/pkg/browser"
)

func main() {
    ctx := context.Background()
    
    // 1. 创建浏览器池
    pool := browser.NewBrowserPool(10, &browser.ConnectOptions{
        Headless: true,
    })
    defer pool.Close()
    
    // 2. 创建监控器
    monitor := NewResourceMonitor(pool, 2*time.Second)
    monitor.Start()
    defer monitor.Stop()
    
    // 3. 使用 TrackedRequest 追踪请求
    TrackedRequest(pool, ctx, func(instance *browser.BrowserInstance) error {
        page := instance.Page()
        return page.Navigate("https://example.com")
    })
    
    // 4. 导出报告
    monitor.ExportToJSON("report.json")
}
```

---

## 🧪 工具 2: 稳定性测试

**位置**: `cmd/stability_test/main.go`

### 功能特点

- ✅ **长时间测试**: 默认运行 5 分钟（可配置）
- ✅ **并发压力**: 可配置并发数
- ✅ **内存追踪**: 检测内存泄漏
- ✅ **自动评估**: 给出稳定性评级

### 快速开始

```bash
# 默认配置（5分钟，5并发）
go run cmd/stability_test/main.go

# 自定义配置
go run cmd/stability_test/main.go -duration=1h -concurrency=10 -delay=1s
```

### 命令行参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `-duration` | `5m` | 测试持续时间 (如: 1h, 30m, 120s) |
| `-concurrency` | `5` | 并发工作协程数 |
| `-delay` | `2s` | 每个请求之间的延迟 |

### 测试示例

```bash
# 短期测试（5分钟）
go run cmd/stability_test/main.go -duration=5m -concurrency=5

# 中期测试（1小时）
go run cmd/stability_test/main.go -duration=1h -concurrency=10

# 长期测试（6小时，推荐睡前运行）
go run cmd/stability_test/main.go -duration=6h -concurrency=5 -delay=3s
```

### 运行时输出

```
╔════════════════════════════════════════════════════════════════╗
║              🧪 浏览器池稳定性测试                              ║
╚════════════════════════════════════════════════════════════════╝

📦 创建浏览器池...
🔥 预热浏览器池 (目标: 5 个实例)...

📊 测试配置:
   - 池大小: 10
   - 并发数: 5
   - 测试时长: 5m0s
   - 请求间隔: 2s
   - 基线内存: 45.23 MB

⏳ 测试开始...
─────────────────────────────────────────────────────────────────
[10s] 📊 请求: 25 (✅ 24 | ❌ 1) | 速率: 2.5/s | 内存: 65.1MB (+19.9MB) | Goroutine: 42 | 池: 8/10
[20s] 📊 请求: 50 (✅ 49 | ❌ 1) | 速率: 2.5/s | 内存: 68.5MB (+23.3MB) | Goroutine: 43 | 池: 7/10
[30s] 📊 请求: 75 (✅ 73 | ❌ 2) | 速率: 2.5/s | 内存: 70.2MB (+25.0MB) | Goroutine: 44 | 池: 8/10
...
```

### 测试报告

测试结束后会显示详细报告：

```
╔════════════════════════════════════════════════════════════════╗
║                    📊 测试报告                                  ║
╚════════════════════════════════════════════════════════════════╝

⏱️  运行时长: 5m2s

📈 请求统计:
   - 总请求数: 756
   - 成功: 742 (98.15%)
   - 失败: 14 (1.85%)
   - 平均速率: 2.51 req/s

💾 内存统计:
   - 基线内存: 45.23 MB
   - 最终内存: 68.50 MB
   - 内存增长: 23.27 MB (51.4%)
   - GC 次数: 45

🔧 Go 运行时:
   - Goroutine: 48

📦 浏览器池:
   - 可用实例: 7/10
   - 总创建数: 10

🎯 稳定性评估:
   ✅ 优秀 - 系统稳定，可用于生产环境
```

### 评估标准

| 评级 | 成功率 | 内存增长 | Goroutine |
|------|--------|----------|-----------|
| ✅ **优秀** | ≥ 95% | < 20% | < 100 |
| 🟡 **良好** | ≥ 80% | < 50% | < 200 |
| ❌ **需改进** | < 80% | ≥ 50% | ≥ 200 |

---

## 🎯 推荐测试流程

### 第一步: 短期测试（5 分钟）

```bash
go run cmd/stability_test/main.go -duration=5m -concurrency=5
```

**目的**: 快速验证基本功能

**通过标准**:
- ✅ 成功率 > 95%
- ✅ 内存增长 < 30%
- ✅ 无崩溃

### 第二步: 中期测试（1 小时）

```bash
go run cmd/stability_test/main.go -duration=1h -concurrency=10
```

**目的**: 验证中等压力下的稳定性

**通过标准**:
- ✅ 成功率 > 95%
- ✅ 内存增长 < 50%
- ✅ Goroutine 稳定 (< 150)

### 第三步: 长期测试（6-24 小时）

```bash
# 推荐睡前运行
nohup go run cmd/stability_test/main.go -duration=24h -concurrency=5 -delay=3s > stability-24h.log 2>&1 &
```

**目的**: 验证长时间运行稳定性

**通过标准**:
- ✅ 成功率 > 90%
- ✅ 内存增长线性且 < 100%
- ✅ 无内存泄漏迹象
- ✅ Goroutine 数量稳定

---

## 📈 性能基准参考

### 典型指标（10实例池，5并发）

| 时长 | 请求数 | 成功率 | 内存增长 | Goroutine |
|------|--------|--------|----------|-----------|
| 5分钟 | ~750 | 98%+ | 20-30MB | 40-50 |
| 1小时 | ~9000 | 97%+ | 50-80MB | 45-60 |
| 6小时 | ~54000 | 95%+ | 100-150MB | 50-70 |

### 你的实际指标

记录你的测试结果：

**5分钟测试** (日期: ________)
- 请求数: ________
- 成功率: ________%
- 内存增长: ________ MB
- Goroutine: ________
- 评级: ________

**1小时测试** (日期: ________)
- 请求数: ________
- 成功率: ________%
- 内存增长: ________ MB
- Goroutine: ________
- 评级: ________

**长期测试** (日期: ________)
- 时长: ________ 小时
- 请求数: ________
- 成功率: ________%
- 内存增长: ________ MB
- Goroutine: ________
- 评级: ________

---

## 🔧 故障排查

### 问题 1: 成功率低于 90%

**可能原因**:
- 网络不稳定
- Chrome 启动超时
- 目标网站响应慢

**解决方案**:
```go
// 增加超时时间
opts := &browser.ConnectOptions{
    Headless: true,
    Args: []string{
        "--disable-gpu",
        "--no-sandbox",
        "--disable-dev-shm-usage", // 重要！
    },
}

// 减少并发数
go run cmd/stability_test/main.go -concurrency=3
```

### 问题 2: 内存持续增长

**可能原因**:
- 内存泄漏
- 实例未正确释放
- Chrome 子进程残留

**解决方案**:
```bash
# 检查 Chrome 进程
ps aux | grep chrome

# 如果有残留进程
pkill -9 chrome

# 检查是否有内存泄漏迹象
go run cmd/stability_test/main.go -duration=10m | grep "内存增长"
```

### 问题 3: Goroutine 数量持续增长

**可能原因**:
- Goroutine 泄漏
- 未正确关闭 context

**检查方法**:
```bash
# 观察 Goroutine 变化趋势
go run cmd/stability_test/main.go -duration=30m
# 如果 Goroutine 持续增长（不稳定），说明有泄漏
```

---

## 💡 最佳实践

### 1. 生产前测试清单

- [ ] 通过 5 分钟快速测试
- [ ] 通过 1 小时中期测试
- [ ] 通过 6 小时长期测试
- [ ] 内存增长 < 100MB (6小时)
- [ ] Goroutine 数量稳定
- [ ] 成功率 > 95%

### 2. 监控频率建议

| 环境 | 监控间隔 | 告警阈值 |
|------|----------|----------|
| 开发 | 不需要 | - |
| 测试 | 每小时 | 成功率 < 90% |
| 生产 | 每 5 分钟 | 成功率 < 95% |

### 3. 资源限制建议

```yaml
# Docker 资源限制
resources:
  limits:
    cpus: '4'
    memory: 8G
  reservations:
    cpus: '2'
    memory: 4G
```

---

## 📊 导出的报告

### 实时监控报告 (JSON)

文件名: `monitor-stats-YYYYMMDD-HHMMSS.json`

```json
{
  "timestamp": "2025-12-13T14:30:45Z",
  "uptime": "5m2s",
  "num_goroutine": 48,
  "memory_alloc_mb": 68.5,
  "memory_sys_mb": 512.0,
  "memory_usage_percent": 13.4,
  "pool_available": 7,
  "pool_created": 10,
  "pool_max_size": 10,
  "total_requests": 756,
  "success_requests": 742,
  "success_rate": 98.15
}
```

---

## 🚀 快速测试命令

```bash
# 1. 快速验证（5分钟）
go run cmd/stability_test/main.go

# 2. 实时监控（带请求）
go run cmd/monitor/main.go

# 3. 长期后台测试（6小时）
nohup go run cmd/stability_test/main.go -duration=6h > stability.log 2>&1 &

# 4. 查看测试进度
tail -f stability.log

# 5. 查看 Chrome 进程数
watch -n 5 'ps aux | grep chrome | wc -l'
```

---

## ❓ 常见问题

**Q: 测试需要多长时间？**
A: 建议至少运行 1 小时，理想情况下运行 6-24 小时。

**Q: 多少成功率算合格？**
A: 生产环境至少 95%，开发测试 90% 即可。

**Q: 内存增长多少算正常？**
A: 运行 1 小时增长 < 100MB 是正常的，如果持续线性增长可能有泄漏。

**Q: 可以同时运行多个测试吗？**
A: 可以，但要注意系统资源限制。

**Q: 如何中断测试？**
A: 按 `Ctrl+C`，程序会优雅关闭并显示报告。

---

**创建日期**: 2025-12-13  
**适用版本**: v1.0+  
**维护状态**: ✅ 活跃维护

