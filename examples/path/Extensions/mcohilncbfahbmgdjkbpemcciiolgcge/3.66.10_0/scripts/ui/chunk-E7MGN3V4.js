import{a as R}from"./chunk-DYL77QBO.js";import{b as $,c as z}from"./chunk-N2MMFEEK.js";import{b as ue}from"./chunk-JABAEAEN.js";import{a as le}from"./chunk-VY2VK2OT.js";import{b as de,c as me}from"./chunk-CZZFLX67.js";import{Gb as T,Ia as ce,h as se}from"./chunk-QRHYK2TW.js";import{k as Z,l as He}from"./chunk-ZDOH3CEJ.js";import{c as w,e as ie}from"./chunk-AS4Z3FNS.js";import{Eb as B,Fd as te,Gd as ne,J as h,Jb as X,L as A,M as Y,Ma as W,Na as H,Pd as re,Ra as S,Sa as Q,Wd as oe,Xd as Xe,Yd as ae,a as j,b as ze,ia as J,md as ee,od as Qe,oe as Ze}from"./chunk-QHXUL3YM.js";import{f as G,m as v,n as x,ra as D,x as y,y as b}from"./chunk-CYTB2B6Q.js";import{o as u,q as d}from"./chunk-SHG7TIBL.js";u();d();D();H();u();d();Q();async function V(e){return!Array.isArray(e)||e.length===0?!1:(await S.assets).set(e)}u();d();Q();async function fe(e){return!Array.isArray(e)||e.length===0?!1:(await S.balance).set(e,{clear:!0})}async function pe(e){try{return await(await S.balance).get(e)}catch{return null}}async function ge(){try{return await(await S.balance).getAll()}catch{return null}}X();u();d();var L=(o=>(o.ERR_NETWORK="ERR_NETWORK",o.ERR_SERVER_LIMIT="ERR_SERVER_LIMIT",o.ERR_SERVER_TINE_LIMIT="ERR_SERVER_TINE_LIMIT",o.ERR_SERVER_COMMON="ERR_SERVER_COMMON",o.ERR_DEFAULT="ERR_DEFAULT",o))(L||{}),Ae=(e,t)=>{if(e?.status&&e.status==="ERR_NETWORK")throw new R("ERR_NETWORK","ERR_NETWORK");if(e?.status&&e.status===429)throw new R("ERR_SERVER_LIMIT","ERR_SERVER_LIMIT");if(e?.status&&e.status===400&&e.data?.code===50113)throw new R("ERR_SERVER_TINE_LIMIT","ERR_SERVER_TINE_LIMIT");if(e?.status&&e.status!==200)throw new R(e?.data?.error_message||e?.data?.msg,"ERR_SERVER_COMMON");if(e?.code!==0&&(e?.error_message||e?.msg))throw new R(e?.error_message||e?.msg,"ERR_SERVER_COMMON");if(t)throw new R(e?.message,"ERR_DEFAULT")},pt=e=>e?.status&&e.status==="ERR_NETWORK"?"ERR_NETWORK":e?.status&&e.status===429?"ERR_SERVER_LIMIT":e?.status&&e.status===400&&e.data?.code===50113?"ERR_SERVER_TINE_LIMIT":e?.status&&e.status!==200||e?.code!==0&&e.status===200&&(e?.error_message||e?.msg)?e?.data?.error_message??e?.data?.msg??"ERR_SERVER_COMMON":"";u();d();D();H();X();u();d();He();ze();var et=Z({name:"balanceSlice",initialState:{balanceMap:{}},reducers:{setBalance:(e,t)=>{e.balanceMap=t.payload}}}),{actions:Ie,reducer:tt}=et;function nt(e){j.captureEvent({message:"STORE_WARN_indexeddb_error",exception:{values:[{type:"STORE_WARN_indexeddb_error",value:e}]},level:"error"})}var yt=()=>async e=>{let t=await ge();if(!t||t.filter?.(s=>!s).length>0){nt(`subscribe balance null, ${JSON.stringify(t)}`);return}let r=t.reduce((s,n)=>(s[n.walletId]=n,s),{});e(Ie.setBalance(r))},{setBalance:Ee}=Ie,ht=tt;u();d();u();d();D();J();function Re({balanceCoins:e,coinsMap:t,flatten:r=!1}){let s=[];return e.forEach(n=>{if(n.childrenCoin){let o=n.childrenCoin.map(a=>({...a,...t.get(a.coinId)}));r?s.push(...o):s.push({...n,...t.get(n.coinId),childrenCoin:o})}else s.push({...n,childrenCoin:void 0,...t.get(n.coinId)})}),s}var Ce=(e,t)=>{let r=e.coinBalanceDetails.map(s=>t.address===s.userAddress&&s.coinId===t.coinId?{...s,coinAmount:String(t.coinAmountOriginalDec),coinAmountOrigin:String(t.coinAmount),currencyAmount:String(t.currencyAmount)}:s);return{...e,coinBalanceDetails:r,coinAmount:r.reduce((s,n)=>A(s,n.coinAmount),"0"),coinAmountOrigin:r.reduce((s,n)=>A(s,n.coinAmountOrigin),"0"),currencyAmount:r.reduce((s,n)=>A(s,n.currencyAmount),"0"),symbol:t.symbol,name:t.name,imageUrl:t.logo}};async function ye({pushData:e,store:t,walletId:r,account:s}){let n=x(t),o=y(t.data.assets,i=>i.walletId===r),a=y(t.data.assets[o].tokens,i=>b(i.coinBalanceDetails,l=>l.coinId===e.coinId));if(a===-1){let i=await ce(e.subBalanceType===1?{aggregationSymbol:e.symbol}:{coinId:e.coinId},e,r,s);if(!i)return!1;n.data.coins.push(...i.coins);let c=t.data.assets[o].tokens.length;n.data.assets[o].tokens[c]=Ce(i.token,e)}else n.data.assets[o].tokens[a]=Ce(t.data.assets[o].tokens[a],e);return n}function he({pushData:e,store:t}){let r=x(t),s=t.data.assets[0].nfts,{receive:n,reduce:o}=e,a=(n||o)?.collectionItem.chainId,i=y(s,c=>b(c.networkValuations,l=>l.chainId===a));return i===-1?n&&r.data.assets[0].nfts.push({networkValuations:[{chainId:a,name:n.collectionItem.name,valuation:h(n.count,n.collectionItem.floorSalePrice?.usdPrice??0)}]}):r.data.assets[0].nfts[i]={...t.data.assets[0].nfts[i],networkValuations:t.data.assets[0].nfts[i].networkValuations.map(c=>({...c,valuation:n?A(c.valuation,h(n.count,n.collectionItem.floorSalePrice?.usdPrice??0)):o&&Y(c.valuation,h(o.count,o.collectionItem.floorSalePrice?.usdPrice??0))}))},r}function Se({pushData:e,store:t,walletId:r}){let s=x(t),n=y(t.data.assets,a=>a.walletId===r),o=y(t.data.assets[n].defis,a=>a.chainId===e.chainId&&a.platformId===e.analysisPlatformId);if(o!==-1){let{platform:a,network:i,url:c,web:l,logo:m,balance:p}=e;s.data.assets[n].defis[o]={...t.data.assets[n].defis[o],defiUrl:c,logo:m,platform:a,balance:p,web:l,network:i}}else s.data.assets[n].defis.push({accountId:r,balance:e.balance,chainId:e.chainId,chainName:e?.chainName,defiUrl:e.url,logo:e.logo,network:e.network,platform:e.platform,platformId:e.analysisPlatformId,walletId:r,web:e.web});return s.data.coins=t.data.coins.map(a=>!a.voucherToken&&b(e.lpTokenAddressList,i=>a.address?i.tokenAddress===a.address:i.chainId===a.chainId)?{...a,voucherToken:!0}:a),s}u();d();var we={};function M(){return we}function _e(e){we=e}async function Te({data:e,channel:t,walletId:r,account:s}){try{return t==="wallet-asset"?await ye({pushData:e,store:M(),walletId:r,account:s}):t==="invest-DeFi"?Se({pushData:e?.data||e,store:M(),walletId:r}):he({pushData:e,store:M(),walletId:r})}catch{return!1}}u();d();J();function xe(e){let t=e.reduce((r,s)=>{let{chainId:n,currencyAmountUSD:o}=s;return r.has(n)?r.set(n,A(r.get(n),o)):r.set(n,o),r},new Map);return Array.from(t).map(([r,s])=>({chainId:r,currencyAmountUSD:s}))}function rt(e,t,r){let{coinAmount:s,currencyAmount:n,coinAmountOrigin:o,...a}=e,i=t.get(e.coinId),c=r?.[e.coinId]?.coinToUSDRate;return{...a,coinAmount:s,coinAmountInt:o,currencyAmountUSD:c?h(s,c):n,baseCoinId:i.baseCoinId}}function be(e,t,r){return e.map(n=>{let{defis:o,nfts:a,tokens:i,accountId:c}=n,l=i?.map(f=>{let{coinAmountOrigin:I,coinBalanceDetails:_,currencyAmount:C,subBalanceType:K,imageUrl:Ge,...Ye}=f,N=_.map(P=>rt(P,t,r)),Je=N[0],q=K===1,F=K===2;return{...Je,...Ye,image:Ge,currencyAmountUSD:N.reduce((P,$e)=>A(P,$e.currencyAmountUSD),"0"),coinAmountInt:I,aggregation:q,isAddressAggregation:F,childrenCoin:q||F?N:void 0}})??null,m=o?.map(f=>({currencyAmountUSD:f.balance,chainId:f.chainId}))??null,p=a?.reduce((f,I)=>f.concat(I.networkValuations||[]),[]).map(f=>({chainId:f.chainId,currencyAmountUSD:f.valuation}))??null;return{defi:m?xe(m):null,nft:p?xe(p):null,coins:l,walletId:c,v:2}})}function We(e,t){let{coins:r,balanceData:s,walletId:n}=e,o=s?.coins??[],a=[];return o.forEach(i=>{if(i.childrenCoin){let c=[];i.childrenCoin.forEach(l=>{l.coinId===+t&&c.push(l)}),c.length>0&&(Object.assign(i,{...c[0],childrenCoin:c}),i.coinAmountInt=c.reduce((l,m)=>A(l,m.coinAmountInt),"0"),i.coinAmount=c.reduce((l,m)=>A(l,m.coinAmount),"0"),i.currencyAmountUSD=c.reduce((l,m)=>A(l,m.currencyAmountUSD),"0"),a.push(i))}else i.coinId===+t&&a.push(i)}),{walletId:n,balanceCoins:a,coins:r.filter(i=>i.coinId===+t)}}u();d();ie();function E(e){return e?.keyring?.selectedWallet}function Be(e,t){let{createdMap:r}=e.metamask;return Boolean(r[t])}function Me(e){let{createdMap:t}=e.metamask;return Object.keys(t??{})}function k(e){return e.metamask.userUniqueId}function ke(e,t){let{createdMap:r}=e.metamask;return r[t]}function Oe(e,t){let{addedCoins:r}=e.metamask;return r[t]||[]}function Ue(e,t){let{reducedCoins:r}=e.metamask;return r[t]||[]}async function Ne(){return w().getCustomCoins()}async function Pe(e,t){return w().setAllCoins(e,t)}function ve(e,t,r=null){return async(s,n)=>{let o=n(),a=E(o),i=k(o);try{let c;r?.channel&&(c=await Te({...r,walletId:a,account:T(o,a)}));let{data:l={}}=c||await B(W.newGetAllAssetsUrl,{userUniqueId:i,accountIds:e,combinationCoins:!0,chainIndexes:t?[t]:void 0},{walletSignParams:{needWalletSign:!0,walletId:a}}),m=l.coins??[],p=l.assets??[],f=new Map(m.map(C=>[C.coinId,se(C)]));_e({data:{coins:m,assets:p.filter(C=>C.walletId===a)}});let I=await ue(le.coinTickers);return{assets:be(p,f,I),coinsMap:f}}catch(c){return Ae(c)}}}function O(e){return async t=>{let r={};e.forEach(s=>{r[s.walletId]=s});try{t(Ee(r)),await fe(e)}catch{G()}}}u();d();Ze();re();u();d();ie();re();Qe();u();d();Xe();function De(e,t){let r=[];return e.reduce((s,n)=>n.childrenCoin?s.concat(...n.childrenCoin):s.concat(n),[]).forEach(s=>{t&&oe.includes(s.coinId)&&r.push(s)}),r}async function Ve(e,t,r={}){let{needSetDefault:s}=r,n=De(e,s);n.length?w().updateWalletAddress(t,n.reduce((o,{coinId:a,userAddress:i})=>{let c=ne({coinId:+a})?.localType,l=ee(c);return Object.entries(r.accountsMap[l]).forEach(([m,p])=>{p.address===i&&(o[l]=m)}),o},{}),{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1}):s&&w().updateWalletAddress(t,{},{needUpdateBalance:!1,needUpdateSegwitAddressType:!0,needSync:!0,needEmitChangeAddress:!1})}function Le({walletData:e,coinsMap:t}){return(r,s)=>{let n=s(),o=e.walletId,a=ke(n,o),c=T(n,o)?.initialType===ae.SIMPLE_KEYRING,l=Oe(n,o),m=Ue(n,o);return $({isReady:!0,defaultBaseCoinsCoinIds:c?a.map(p=>p.coinId):[],addedCoins:l,reducedCoins:m,balanceCoins:Re({balanceCoins:e.coins,coinsMap:t,flatten:!1}),defi:e.defi,nft:e.nft,hiddenSmallAssets:!0,networks:te()})}}function Ke({coinsMap:e,walletData:t}){return async(r,s)=>{let n=s(),o=T(n,t.walletId);Ve(t.coins,t.walletId,o);let a=await Ne();E(n)===t.walletId&&(Pe(Array.from(e.values()),a),r(O([t])))}}var qe=50,U=!1;function Fe({walletIds:e,chainId:t,pushData:r}){return async(s,n)=>{let o=n(),a=[],i=!t;return await Promise.all(v(e,qe).map(async c=>{let{assets:l,coinsMap:m}=await s(ve(c,t,r)),p=[];l.forEach(f=>{let{walletId:I}=f;if(i){let _=s(Le({walletData:f,coinsMap:m}));_&&p.push({walletId:I,..._});let C=E(o);I===C&&s(Ke({coinsMap:m,walletData:f}))}a.push({walletId:I,coins:Array.from(m.values()),balanceData:f})}),i&&V(p)})),a}}function je(e){return async(t,r)=>{let s=r(),n=E(s);if(!(!n||!Be(s,n))){try{await t(Fe({walletIds:[n],pushData:e}))}catch(a){let i=await pe(n);throw await t(O([{...i??{},walletId:n,error:!0,v:2}])),a}if(me()){de();let a=setTimeout(()=>{t(je()),clearTimeout(a)},2e3)}}}}function $n(e){return async(t,r)=>{let s=r();E(s)===e&&await t(je())}}function zn({walletIds:e,chainId:t,coinId:r}){return async s=>{let n=await s(Fe({walletIds:e,chainId:t}));return n?.length?n.map(o=>We(o,r)):null}}function Hn(){return async(e,t)=>{if(U)return;let r=t();U=!0;let s=Me(r),n=E(r),o=k(r);try{await Promise.all(v(s,qe).map(async a=>{let{data:i={}}=await B(W.getWalletManageAsset,{userUniqueId:o,accountIds:a},{walletSignParams:{needWalletSign:!0,walletId:n}}),c=r.metamask.preferences.showNftAmount,l=i.map(m=>z(m,c));V(l)})),U=!1}catch(a){throw U=!1,L[a?.message]?new Error(a?.message):new Error(a)}}}export{L as a,Ae as b,pt as c,yt as d,ht as e,Fe as f,je as g,$n as h,zn as i,Hn as j};

window.inOKXExtension = true;
window.inMiniApp = false;
window.ASSETS_BUILD_TYPE = "publish";

//# sourceMappingURL=chunk-E7MGN3V4.js.map
