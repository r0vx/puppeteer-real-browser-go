import{c as $,i as K}from"./chunk-OK4242CI.js";import{a as z}from"./chunk-T4RFDN7D.js";import{a as j}from"./chunk-IEGAVAV7.js";import{a as q}from"./chunk-V4P2E4SN.js";import{a as O}from"./chunk-MN3UHDTX.js";import{a as m,b as w}from"./chunk-7C7MBE2C.js";import{b as h}from"./chunk-KJWX5V23.js";import{a as v}from"./chunk-VY2VK2OT.js";import{o as ie}from"./chunk-XP3TNE3R.js";import{jc as ae}from"./chunk-QRHYK2TW.js";import{Eb as W,Jb as ce,Ma as x,Na as se}from"./chunk-QHXUL3YM.js";import{f as U,m as p,ma as B,ra as oe}from"./chunk-CYTB2B6Q.js";import{b as te}from"./chunk-OL67KS7C.js";import{f as b,o as E,q as P}from"./chunk-SHG7TIBL.js";E();P();var u=b(te()),L=b(ae()),t=b(ie());oe();se();ce();var f=300,Se=()=>{let N=j(),k=(0,L.useDispatch)(),C=$(N),I=z(),d=(0,u.useRef)({}),g=(0,u.useRef)({}),A=(0,u.useRef)({}),{data:_,set:G}=q(v.coinTickers),T=K();(0,u.useEffect)(()=>{k(O(T))},[k,T]);let M=o=>{G({..._,...o})},S=(0,t.useMemoizedFn)(async o=>{let c=p(o,f),r=[];try{(await Promise.all(c.map(n=>{let y=n.filter(a=>A.current[a]),s={coinIds:n,aggregationCoinIdList:y},i={headers:{currency:"usd"}};return W(x.postMarketUrl,s,i)})))?.forEach(n=>{Array.isArray(n?.data)&&(r=r.concat(n.data))})}catch{U()}r.forEach(e=>{e?.coinId&&(g.current[e.coinId]={coinToUSDRate:e?.currencyAmount,coinPriceChangePercent24h:e?.priceChangePercent24h,priceCoinId:e?.priceCoinId,anchorStatus:e?.anchorStatus??null})}),M(g.current)}),{needFetchCoinIds:H,needFetchData:J}=(0,t.useCreation)(()=>{if(C.length||I.length){let o=C.concat(I).filter(e=>Boolean(e?.coinId));return B(o,"coinId").reduce((e,n)=>(e.needFetchCoinIds.push(n.coinId),e.needFetchData.push({coinId:n.coinId,baseCoinId:n?.baseCoinId,chainIndex:n?.chainId,tokenAddress:n?.address,aggregation:n?.aggregation}),e),{needFetchCoinIds:[],needFetchData:[]})}return{needFetchCoinIds:[],needFetchData:[]}},[C,I]),Q=(0,t.useMemoizedFn)(o=>{if(!o?.length)return;let{coinIdToInstIdMap:c,coinIdAggregationMap:r}=o.reduce((s,i)=>{let{coinIdToInstIdMap:a,coinIdAggregationMap:D}=s,{coinId:R,baseCoinId:ee,chainIndex:F,tokenAddress:ne,aggregation:re}=i,l="";return ee===0?l=`${F}`:l=`${F}-${ne}`,a[R]=l,D[R]=re,{coinIdToInstIdMap:a,coinIdAggregationMap:D}},{coinIdToInstIdMap:{},coinIdAggregationMap:{}});A.current=r;let e=[],n=Object.entries(c).reduce((s,[i,a])=>(d.current[i]||(d.current[i]=a,e.push(i),s.push({channel:h,instId:a})),s),[]);p(n,f).forEach(s=>{m.sendChannel({op:"subscribe",args:s})}),e.length&&S(e)}),{run:V}=(0,t.useDebounceFn)(Q,{wait:200}),{run:X}=(0,t.useDebounceFn)(()=>{M(g.current)},{wait:1e3}),Y=(0,t.useMemoizedFn)(()=>{S(Object.keys(d.current))}),Z=(0,t.useMemoizedFn)(o=>{if(!o||!Array.isArray(o?.data))return;let{data:c}=o,r=c[0];if(r?.coinId){let e=r.coinId,n=g.current[e];g.current[e]={...n,coinToUSDRate:r.price,coinPriceChangePercent24h:r.priceChangePercent24h},X()}});w(h,{onError:Y,onSuccess:Z,pollingInterval:30*1e3}),(0,t.useDeepCompareEffect)(()=>{V(J)},[H]),(0,t.useUnmount)(()=>{let o=Object.values(d.current).map(r=>({channel:h,instId:r}));p(o,f).forEach(r=>{m.sendChannel({op:"unsubscribe",args:r})}),d.current={}})};export{Se as a};

window.inOKXExtension = true;
window.inMiniApp = false;
window.ASSETS_BUILD_TYPE = "publish";

//# sourceMappingURL=chunk-64GFKAIL.js.map
